<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <title>ü©∫ ƒê·∫∑t l·ªãch kh√°m | Ph√≤ng kh√°m T·∫≠n T√¢m</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body {
            background: #E3F2FD;
            font-family: 'Roboto', sans-serif;
            min-height: 100vh;
        }

        /* üåà Navbar */
        .navbar {
            background: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-bottom: 4px solid #007bff;
            padding: 15px 5%;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: #0056b3 !important;
            display: flex;
            align-items: center;
        }

        .navbar-brand img {
            width: 45px;
            margin-right: 10px;
        }

        /* ‚≠êÔ∏è ƒê·ªíNG B·ªò: N√öT QUAY L·∫†I & L·ªäCH ƒê√É ƒê·∫∂T ‚≠êÔ∏è */
        .navbar .btn-light {
            color: #0056b3;
            background-color: transparent;
            border: 2px solid #0056b3;
            font-weight: 600;
            transition: all 0.2s;
            border-radius: 8px;
            padding: 8px 15px;
        }
        .navbar .btn-light:hover {
            color: #fff;
            background-color: #007bff;
            border-color: #007bff;
            transform: translateY(-1px);
        }

        /* ‚≠êÔ∏è ƒê·ªíNG B·ªò: N√öT ƒêƒÇNG XU·∫§T ‚≠êÔ∏è */
        .navbar .btn-primary {
            background-color: #007bff; /* M√†u xanh d∆∞∆°ng ch√≠nh */
            border-color: #007bff;
            font-weight: 600;
            transition: all 0.2s;
            border-radius: 8px;
            padding: 8px 15px;
        }
        .navbar .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
            transform: translateY(-1px);
        }

        /* üåü Card ch√≠nh */
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            background: #fff;
            padding: 2.5rem 3rem;
            max-width: 800px;
            margin: 60px auto;
            transition: all 0.3s;
        }

        h3 {
            font-weight: 700;
            color: #0056b3;
            text-align: center;
            margin-bottom: 1.8rem;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0f2f7;
        }

        label {
            font-weight: 600;
    color: #0056b3; /* ‚≠êÔ∏è THAY ƒê·ªîI M√ÄU S·∫ÆC TH√ÄNH XANH ƒê·∫¨M ‚≠êÔ∏è */
    margin-bottom: 5px; /* Th√™m kho·∫£ng c√°ch d∆∞·ªõi nh√£n */
    display: block;
        }

        .form-control, .form-select {
            border-radius: 8px;
            padding: 10px 14px;
            border: 1px solid #ddd;
            transition: all 0.2s ease;
        }

        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
            border-color: #007bff;
        }

        /* üïì Time slot */
        .time-slot {
            display: inline-block;
            background: #f1f3f4;
            padding: 10px 16px;
            margin: 6px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            border: 1px solid transparent;
            transition: all 0.25s ease;
        }

        .time-slot:hover:not(.disabled) {
            background: #0056b3;
            color: #fff;
            transform: translateY(-2px);
        }

        .time-slot.selected {
            background: #007bff;
            color: #fff;
            border-color: #0056b3;
        }

        .time-slot.disabled {
            background: #e0e0e0;
            color: #777;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* üü¢ N√∫t ch√≠nh */
        .btn-main {
            font-weight: 600;
            padding: 12px 22px;
            border-radius: 10px;
            font-size: 16px;
            background-color: #28a745;
            border: none;
        }

        .btn-main:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        .loading {
            text-align: center;
            color: #0d6efd;
            font-weight: 500;
            display: none;
        }

        small.text-muted {
            font-size: 13px;
        }

        .alert {
            border-radius: 12px;
            font-weight: 500;
        }
    </style>
</head>

<body>

<nav class="navbar navbar-expand-lg">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <a class="navbar-brand" th:href="@{/benhnhan/}">
            <img th:src="@{/images/icon-phongkham.png}" alt="Logo T·∫≠n T√¢m">
            Ph√≤ng kh√°m T·∫≠n T√¢m
        </a>
        <div>
            <a th:href="@{/benhnhan/}" class="btn btn-light me-2">
                <i class="bi bi-arrow-left-circle"></i> Quay l·∫°i
            </a>
            <a th:href="@{/benhnhan/lich-kham(mode='calendar')}" class="btn btn-light me-2">
                <i class="bi bi-calendar3"></i> L·ªãch ƒë√£ ƒë·∫∑t
            </a>
            <form th:action="@{/logout}" method="post" class="d-inline">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-box-arrow-right"></i> ƒêƒÉng xu·∫•t
                </button>
            </form>
        </div>
    </div>
</nav>

<div class="container">
    <div class="card">
        <h3><i class="bi bi-calendar2-check"></i> ƒê·∫∑t l·ªãch kh√°m</h3>

        <div th:if="${successMessage}" class="alert alert-success text-center" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert-danger text-center" th:text="${errorMessage}"></div>

        <form th:action="@{/benhnhan/dat-lich}" method="post" onsubmit="return validateForm()">

            <div class="mb-3">
                <label><i class="bi bi-person-circle"></i> B·ªánh nh√¢n:</label>
                <input type="text" class="form-control" th:value="${benhNhan.nguoi.hoTen}" readonly>
                <input type="hidden" name="maBenhNhan" th:value="${benhNhan.maBenhNhan}">
            </div>

            <div class="mb-3">
                <label><i class="bi bi-hospital"></i> Ch·ªçn khoa:</label>
                <select class="form-select" id="khoa" name="maKhoa" required>
                    <option value="">-- Ch·ªçn khoa --</option>
                    <option th:each="k : ${khoaList}" th:value="${k.maKhoa}" th:text="${k.tenKhoa}"></option>
                </select>
            </div>

            <div class="mb-3">
                <label><i class="bi bi-person-badge"></i> Ch·ªçn b√°c sƒ©:</label>
                <select class="form-select" id="bacSi" name="maBacSi" required>
                    <option value="">-- Ch·ªçn b√°c sƒ© --</option>
                </select>
            </div>

            <div class="mb-3">
                <label><i class="bi bi-calendar-event"></i> Ch·ªçn ng√†y kh√°m:</label>
                <input type="date" id="ngayKham" name="ngayKham" class="form-control" required>
                <small class="text-muted">‚ö†Ô∏è Ch·ªâ ƒë∆∞·ª£c ch·ªçn trong v√≤ng 7 ng√†y t·ªõi</small>
            </div>

            <div class="mb-3">
                <label><i class="bi bi-clock"></i> Ch·ªçn khung gi·ªù kh√°m:</label>
                <div id="loadingText" class="loading">‚è≥ ƒêang t·∫£i khung gi·ªù kh·∫£ d·ª•ng...</div>
                <div id="timeSlots" class="d-flex flex-wrap justify-content-start"></div>
                <input type="hidden" name="gioBatDau" id="gioBatDau">
                <input type="hidden" name="gioKetThuc" id="gioKetThuc">
            </div>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-success btn-main">
                    ‚úÖ X√°c nh·∫≠n ƒë·∫∑t l·ªãch
                </button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // === Gi·ªõi h·∫°n ng√†y trong 7 ng√†y t·ªõi ===
    const today = new Date();
    const maxDay = new Date(today);
    maxDay.setDate(today.getDate() + 7);

    const inputDate = document.getElementById("ngayKham");
    inputDate.min = today.toISOString().split("T")[0];
    inputDate.max = maxDay.toISOString().split("T")[0];

    const khungGioMacDinh = [
        ["08:00", "08:30"], ["08:30", "09:00"],
        ["09:00", "09:30"], ["09:30", "10:00"],
        ["13:30", "14:00"], ["14:00", "14:30"],
        ["15:30", "16:00"], ["16:00", "16:30"]
    ];

    const timeSlotsDiv = document.getElementById("timeSlots");
    const loadingText = document.getElementById("loadingText");

    inputDate.addEventListener("change", loadAvailableTimeSlots);
    document.getElementById("bacSi").addEventListener("change", loadAvailableTimeSlots);

    async function loadAvailableTimeSlots() {
        const bacSiId = document.getElementById("bacSi").value;
        const ngayKham = inputDate.value;

        if (!bacSiId || !ngayKham) {
            renderTimeSlots(khungGioMacDinh, []);
            return;
        }

        loadingText.style.display = "block";
        timeSlotsDiv.innerHTML = "";

        try {
            // FIX: ƒê·∫£m b·∫£o URL API l√† ƒë√∫ng
            const response = await fetch(`/api/lich-kham/da-dat?MaBacSi=${bacSiId}&ngayKham=${ngayKham} 00:00:00`);
            const gioDaDat = await response.json();
            renderTimeSlots(khungGioMacDinh, gioDaDat);
        } catch (err) {
            console.error("‚ùå L·ªói t·∫£i khung gi·ªù:", err);
            renderTimeSlots(khungGioMacDinh, []);
        } finally {
            loadingText.style.display = "none";
        }
    }

    function renderTimeSlots(slots, disabledTimes) {
        timeSlotsDiv.innerHTML = "";

        slots.forEach(slot => {
            const btn = document.createElement("div");
            btn.className = "time-slot";
            btn.textContent = `${slot[0]} - ${slot[1]}`;

            // Chuy·ªÉn m·∫£ng gioDaDat th√†nh Set ƒë·ªÉ ki·ªÉm tra nhanh h∆°n
            const disabledSet = new Set(disabledTimes.map(time => time.substring(0, 5)));

            // Ki·ªÉm tra xem gi·ªù b·∫Øt ƒë·∫ßu (HH:MM) c√≥ trong danh s√°ch ƒë√£ ƒë·∫∑t kh√¥ng
            if (disabledSet.has(slot[0])) {
                btn.classList.add("disabled");
                btn.title = "ƒê√£ c√≥ ng∆∞·ªùi ƒë·∫∑t";
            } else {
                btn.onclick = () => selectTimeSlot(slot, btn);
            }

            timeSlotsDiv.appendChild(btn);
        });
    }

    function selectTimeSlot(slot, el) {
        if (el.classList.contains("disabled")) return;
        document.querySelectorAll(".time-slot").forEach(e => e.classList.remove("selected"));
        el.classList.add("selected");
        document.getElementById("gioBatDau").value = slot[0];
        document.getElementById("gioKetThuc").value = slot[1];
    }

    // Load b√°c sƒ© theo khoa
    document.getElementById("khoa").addEventListener("change", function () {
        const khoaId = this.value;
        const bacSiSelect = document.getElementById("bacSi");
        bacSiSelect.innerHTML = '<option value="">-- Ch·ªçn b√°c sƒ© --</option>';

        if (khoaId) {
            fetch(`/benhnhan/bacsi-by-khoa/${khoaId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.length === 0) {
                        const opt = document.createElement("option");
                        opt.text = "Kh√¥ng c√≥ b√°c sƒ© trong khoa n√†y";
                        opt.disabled = true;
                        bacSiSelect.appendChild(opt);
                    } else {
                        data.forEach(bs => {
                            const option = document.createElement("option");
                            option.value = bs.maBacSi;
                            option.text = bs.nguoi.hoTen;
                            bacSiSelect.appendChild(option);
                        });
                    }
                    // Trigger loadAvailableTimeSlots sau khi b√°c sƒ© ƒë∆∞·ª£c t·∫£i
                    loadAvailableTimeSlots();
                })
                .catch(err => console.error("L·ªói load b√°c sƒ©:", err));
        } else {
            // Reset khung gi·ªù khi kh√¥ng ch·ªçn khoa
            renderTimeSlots(khungGioMacDinh, []);
        }
    });

    // Validate form
    function validateForm() {
        const khoa = document.getElementById("khoa").value;
        const bacSi = document.getElementById("bacSi").value;
        const ngay = document.getElementById("ngayKham").value;
        const gio = document.getElementById("gioBatDau").value;

        if (!khoa || !bacSi) {
            alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß khoa v√† b√°c sƒ©!");
            return false;
        }
        if (!ngay) {
            alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn ng√†y kh√°m!");
            return false;
        }
        if (!gio) {
            alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn khung gi·ªù kh√°m!");
            return false;
        }
        return true;
    }
</script>

</body>
</html>